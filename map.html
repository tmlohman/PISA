<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript">  
		
        function draw(geo_data) {
	        "use strict";
	        // draw the map
	        var margin = 75,
	            width = 1500 - margin,
	            height = 730 - margin;
	
	        var svg = d3.select("body")
	            .append("svg")
	            .attr("width", width + margin)
	            .attr("height", height + margin)
	            .append('g')
	            .attr('class', 'map');
	       
	        var projection = d3.geo.mercator()
								   .scale(130)
								   .translate([width/2, height/1.3]);
	        
	        var path = d3.geo.path().projection(projection);
	
	        var map = svg.selectAll('path')
						 .data(geo_data.features)
						 .enter()
						 .append('path')
						 .attr('d', path)
						 .style('fill', '#f7fbff')	 
						 .style('stroke', 'black')
						 .style('stroke-width', 0.5)
                         .append('svg:title')
                         .text(function(d) {
						        return d.properties.name
					         });
    
				function pick_color(data) {
					data.map(function (d) {
							d.math_avg = +d.math_avg;
							d.reading_avg = +d.reading_avg;
							d.science_avg = +d.science_avg;
					})
					
					var colors = ["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"];		
					var score_extent = d3.extent(data, function(d) {
							return d.math_avg;
						});
						
					var score_scale = d3.scale.quantile()
									   .domain(score_extent)
									   .range(colors);
							
					var color_assignments = {};
					
					var l = data.length;
					for (var i = 0; i < l; i++) {
						color_assignments[data[i].country] = score_scale(data[i].math_avg);
					}
					
					function update_color(d) {
						if (d.properties.name in color_assignments) {
							return color_assignments[d.properties.name]
						} else {
							return 'white'
						}
					}
					

										
					svg.selectAll('path')
                       .style('fill', update_color)
                       
                       
				}
			
				d3.csv("avg_scores_by_country_complete2.csv", pick_color)	
			
		}
           
	d3.json("world_countries.json", draw);
    </script>
</body>
</html>
