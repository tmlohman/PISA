<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <style type="text/css">
	  
	  
	#outer {
		position: fixed;
		width: 100%;
		height: 100%;
	}
	#map_div {
	    float: left;
	    width: 64%;
	    height: 100%;
	    border: 1px solid red;
	}
	#scatter_div {
	    float: right;
	    width: 35%;
	    height: 50%;
	    border: 1px solid red;
	} 
	#text_div {
		float: right;
	    width: 35%;
	    height: 50%;
	    border: 1px solid red;
	}  
	</style>
  
    <body>
	<div id = outer>
		<div id = map_div>
			<form name = "chooseSubject">
			<input type="radio" name="subject" value="math", checked = "checked", onchange="redraw('math');"> Math<br>
			<input type="radio" name="subject" value="reading" onchange="redraw('reading');"> Reading<br>
			<input type="radio" name="subject" value="science", onchange="redraw('science');"> Science
			</form>
		</div>
		<div id = scatter_div></div>
		<div id = text_div></div>
	</div>

    <script type="text/javascript">  
  		
	function draw(geo_data) {
        "use strict";
        // set dimensions
        var map_div = document.getElementById('map_div'); 
		var map_width = map_div.offsetWidth;
		var map_height = map_div.offsetHeight;
		var map_margin = 75;
		var map_scale = map_width / 6.5;
    
        // draw the map
        var svg = d3.select("#map_div")
            .append("svg")
            .attr("width", map_width + map_margin)
            .attr("height", map_height + map_margin)
            .append('g')
            .attr('class', 'map');
       
        var projection = d3.geo.mercator()
							   .scale(map_scale)
							   .translate([map_width/2, map_height/1.8]);
        
        var path = d3.geo.path().projection(projection);

        var map = svg.selectAll('path')
					 .data(geo_data.features)
					 .enter()
					 .append('path')
					 .attr('d', path)
					 .style('fill', '#f7fbff')	 
					 .style('stroke', 'black')
					 .style('stroke-width', 0.5)
					 .append('svg:title')
					 .text(function(d) {
					        return d.properties.name
				         })
				     .append('svg:legend');
			         
		d3.csv("avg_scores_by_country_complete3.csv", pick_color)	
	}
		
	function pick_color(data) {
		var svg = d3.select("#map_div")
		data.map(function (d) {
				d.math = +d.math;
				d.reading = +d.reading;
				d.science = +d.science;
		})
		
		// color code by subject
		if (subject == "math") {
			var colors = ["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"];
		}
		if (subject == "reading") {
			var colors = ["#edf8e9","#bae4b3","#74c476","#31a354","#006d2c"];
		}
		if (subject == "science") {
			var colors = ["#feedde","#fdbe85","#fd8d3c","#e6550d","#a63603"];
		}
			
					
		var score_extent = d3.extent(data, function(d) {
				return d[subject];
			});
			
		var score_scale = d3.scale.quantile()
						   .domain(score_extent)
						   .range(colors);

		// create object that pairs countries with correct color		
		var color_assignments = {};
		var l = data.length;
		for (var i = 0; i < l; i++) {
			color_assignments[data[i].country] = score_scale(data[i][subject]);
		}

		function update_color(d) {
			if (d.properties.name in color_assignments) {
				return color_assignments[d.properties.name]
			} else {
				return 'white'
			}
		}
		
		// create object that pairs countries with math scores
		var scores = {};
		for (var i = 0; i < l; i++) {
			scores[data[i].country] = data[i][subject].toFixed(0);
		}
		
		function update_score(d) {
			if (d.properties.name in color_assignments) {
				return [d.properties.name,
				scores[d.properties.name]];
			} else {
				return [d.properties.name, "no data available"];
			}
		}
		
		// click code
		function on_click(d) {
			country = d.properties.name;
			if (selected_countries.includes(country)) {
				var i = selected_countries.indexOf(country);
				selected_countries.splice(i, 1);
			} else {
				selected_countries.push(country);
			};
			d3.csv('quintiles.csv', update_scatter)
		};

		// update colors, hover-text					
		svg.selectAll('path')
		   .style('fill', update_color)
		   .on('click', on_click)
		   
		
		svg.selectAll('title')
		   .text(update_score)
		
		// draw legend
		var min_score = score_extent[0].toFixed(0)
		var max_score = score_extent[1].toFixed(0)
		color_scale = {}
		for (var i = min_score; i < max_score; i++) {
			color_scale[i] = score_scale(i)
			if (color_scale[i-1] == color_scale[i]) {
				delete color_scale[i-1];
			}
		}	
	}
	
	// draws scatter plot axis
	function add_scatter(data) {
		"use strict"
		var country = "USA"

		data.map(function (d) {
							d.prob = +d.prob;
							d.escs = +d.escs;
							d.math = +d.math;
							d.reading = +d.reading;
							d.science = +d.science;
				});

		var scatter = d3.select("#scatter_div")
					.append("svg")
					.attr("width", scatter_width)
					.attr("height", scatter_height)
					.append('g')
					.attr('class', 'chart');
					
		// bind data to circles
		scatter.selectAll('circle')
		       .data(data.filter(function(d) { return d.country == country }))
		       .enter()
		       .append('circle')
		       
		var x_translate = scatter_height - scatter_margin
		//append x-axis
		scatter.append('g')
			   .attr('class', 'x axis')
			   .attr('transform', "translate(0 ," + x_translate + ")")
			   .call(escs_axis);
		   
		// append y-axis	
		scatter.append('g')
			   .attr('class', 'y axis')
			   .attr('transform', "translate("+ scatter_margin +", 0)")
			   .call(score_axis);
			
		scatter.selectAll('circle')
			   .attr("id", function(d) { return d.country })
               .attr('cx', function(d) {
                  return x_scale(d['escs']);
                })
               .attr('cy', function(d) {
                  return y_scale(d[subject]);
                })
               .attr('r', radius)
               .attr('fill', 'blue');
               
		d3.csv('quintiles.csv', clear_scatter);
	}
	
	// updates scatter plot when country is clicked
	function update_scatter(data) {
		var scatter = d3.select("#scatter_div")
		console.log(selected_countries);
		
		// drop first country if more than 5 are selected
		if (selected_countries.length > 5) {
			drop_country = selected_countries[0];
			var data_upd = scatter.select('svg')
                              .selectAll('circle')
                              .data(data.filter( function(d) { 
								  return d['country'] == drop_country}),  
								  function(d) { return d.row; });
			data_upd.remove();
			selected_countries.splice(0, 1);
			var first_color = scatter_colors[0];
			scatter_colors.splice(0,1);
			scatter_colors.push(first_color);
		};	
				
		console.log(selected_countries);
		
		var i = selected_countries.indexOf(country);
		console.log(i);
		
		
		

		// select matching data
        var data_upd = scatter.select('svg')
                              .selectAll('circle')
                              .data(data.filter( function(d) { 
								  return d['country'] == country}),  
								  function(d) { return d.row; });

		data_ent = data_upd.enter();
      	
        // old circles, removed
        data_upd.remove();
	
        // new circles, added
  	    data_ent.append('circle')
		  	    //.attr('id', function(d) { return d.country })
			    .attr('cx', function(d) {
		                  return x_scale(d['escs']);
		                })
		               .attr('cy', function(d) {
		                  return y_scale(d[subject]);
		                })
		        .attr('r', 5)
		        .attr('fill', scatter_colors[i]);
		
		
	}
	function clear_scatter(data) {
		var scatter = d3.select("#scatter_div")
		
		var data_upd = scatter.select('svg')
                              .selectAll('circle')
                              .data(data)
                              
		data_upd.remove();
	}
		
	
	
    // global variables
    var selected_countries = [];
    var scatter_colors = ["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e"];
    
	// set scatter plot dimensions
	var scatter_div = document.getElementById('scatter_div'); 
	var scatter_width = scatter_div.offsetWidth;
	var scatter_height = scatter_div.offsetHeight;
	var scatter_margin = 50;
	var radius = 5
	
	// horizontal axis
	var x_extent = [-2.75, 3.70];
	var x_scale = d3.scale.linear()
		.domain(x_extent)
		.range([scatter_margin, scatter_width - scatter_margin]);
	var escs_axis = d3.svg.axis()
		.scale(x_scale);
	  
	// vertical axis
	var y_extent = [312, 672];
	var y_scale = d3.scale.linear()
		.domain(y_extent)
		.range([scatter_height - scatter_margin, scatter_margin]);
	var score_axis = d3.svg.axis()
		.scale(y_scale)
		.orient("left");

    		
	function redraw(c) {
		subject = c;
		d3.csv("avg_scores_by_country_complete3.csv", pick_color);
		d3.csv('quintiles.csv', clear_scatter);
	}
	
	subject = "math"
	d3.json("world_countries.json", draw);
	d3.csv('quintiles.csv', add_scatter);


    </script>
    
</body>
</html>
