<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.9.0/d3-legend.js"></script>
  
    <body>

	<form name = "chooseSubject">
	  <input type="radio" name="subject" value="math", checked = "checked", onchange="redraw('math');"> Math<br>
	  <input type="radio" name="subject" value="reading" onchange="redraw('reading');"> Reading<br>
	  <input type="radio" name="subject" value="science", onchange="redraw('science');"> Science
	</form>

	
    <script type="text/javascript">  
  		
        function draw(geo_data) {
	        "use strict";
	        // draw the map
	        var margin = 75,
	            width = 1500 - margin,
	            height = 730 - margin;
	
	        var svg = d3.select("body")
	            .append("svg")
	            .attr("width", width + margin)
	            .attr("height", height + margin)
	            .append('g')
	            .attr('class', 'map');
	       
	        var projection = d3.geo.mercator()
								   .scale(160)
								   .translate([width/3, height/1.5]);
	        
	        var path = d3.geo.path().projection(projection);
	
	        var map = svg.selectAll('path')
						 .data(geo_data.features)
						 .enter()
						 .append('path')
						 .attr('d', path)
						 .style('fill', '#f7fbff')	 
						 .style('stroke', 'black')
						 .style('stroke-width', 0.5)
                         .append('svg:title')
                         .text(function(d) {
						        return d.properties.name
					         })
					     .append('svg:legend');
					         
				d3.csv("avg_scores_by_country_complete3.csv", pick_color)	
		}
		
	function pick_color(data) {
		var svg = d3.select("body")
					data.map(function (d) {
							d.math = +d.math;
							d.reading = +d.reading;
							d.science = +d.science;
					})
					
					if (choice == "math") {
						var colors = ["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"];
					}
					if (choice == "reading") {
						var colors = ["#edf8e9","#bae4b3","#74c476","#31a354","#006d2c"];
					}
					if (choice == "science") {
						var colors = ["#feedde","#fdbe85","#fd8d3c","#e6550d","#a63603"]
					}
						
								
					var score_extent = d3.extent(data, function(d) {
							return d[choice];
						});
						
					var score_scale = d3.scale.quantile()
									   .domain(score_extent)
									   .range(colors);

					
					// create object that pairs countries with correct color		
					var color_assignments = {};
					var l = data.length;
					for (var i = 0; i < l; i++) {
						color_assignments[data[i].country] = score_scale(data[i][choice]);
					}
					
					function update_color(d) {
						if (d.properties.name in color_assignments) {
							return color_assignments[d.properties.name]
						} else {
							return 'white'
						}
					}
					
					// create object that pairs countries with math scores
					var scores = {};
					for (var i = 0; i < l; i++) {
						scores[data[i].country] = data[i][choice].toFixed(0);
					}
					
					function update_score(d) {
						if (d.properties.name in color_assignments) {
							return [d.properties.name,
							scores[d.properties.name]];
						} else {
							return [d.properties.name, "no data available"];
						}
					}
					
					// click code
					function on_click(d) {
						window.open(height = 300, width = 300);
					}

					// update colors, hover-text					
					svg.selectAll('path')
                       .style('fill', update_color)
                       .on('click', on_click)
                       
                    
                    svg.selectAll('title')
					   .text(update_score)
					
					// draw legend
					var min_score = score_extent[0].toFixed(0)
					var max_score = score_extent[1].toFixed(0)
					color_scale = {}
					for (var i = min_score; i < max_score; i++) {
						color_scale[i] = score_scale(i)
						if (color_scale[i-1] == color_scale[i]) {
							delete color_scale[i-1];
						}
					}
					

					
					var svg = d3.select("svg");
					
					svg.append("g")
					  .attr("class", "legendQuant")
					  .attr("transform", "translate(20,20)");
					
					var legend = d3.legend.colors()
					  .labelFormat(d3.format(".2f"))
					  .useClass(true)
					  .scale(score_scale);
					
					svg.select(".legendQuant")
					  .call(legend);
						
				}
    
		
	function redraw(c) {
		choice = c;
		d3.csv("avg_scores_by_country_complete3.csv", pick_color)
	}
	
	choice = "math"
	d3.json("world_countries.json", draw);


    </script>
    
</body>
</html>
