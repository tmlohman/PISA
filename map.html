<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <style type="text/css">
	  
	  
	#outer {
		position: fixed;
		width: 100%;
		height: 100%;
	}
	#map_div {
	    float: left;
	    width: 64%;
	    height: 100%;
	    border: 1px solid red;
	}
	#scatter_div {
	    float: right;
	    width: 35%;
	    height: 50%;
	    border: 1px solid red;
	} 
	#text_div {
		float: right;
	    width: 35%;
	    height: 50%;
	    border: 1px solid red;
	}  
	</style>
  
    <body>
	<div id = outer>
		<div id = map_div></div>
		<div id = scatter_div></div>
		<div id = text_div></div>
	</div>


	<form name = "chooseSubject">
	  <input type="radio" name="subject" value="math", checked = "checked", onchange="redraw('math');"> Math<br>
	  <input type="radio" name="subject" value="reading" onchange="redraw('reading');"> Reading<br>
	  <input type="radio" name="subject" value="science", onchange="redraw('science');"> Science
	</form>

	
    <script type="text/javascript">  
		var map_div = document.getElementById('map_div'); 
		var map_width = map_div.offsetWidth;
		var map_height = map_div.offsetHeight;
		var map_margin = 75;
		var map_scale = map_width / 6.5;

		
		var scatter_div = document.getElementById('scatter_div'); 
		var scatter_width = scatter_div.offsetWidth;
		var scatter_height = scatter_div.offsetHeight;
		var scatter_margin = 50;
  		
        function draw(geo_data) {
	        "use strict";
	        // set dimensions
	        var map_div = document.getElementById('map_div'); 
			var map_width = map_div.offsetWidth;
			var map_height = map_div.offsetHeight;
			var map_margin = 75;
	    
	        // draw the map
	        var svg = d3.select("#map_div")
	            .append("svg")
	            .attr("width", map_width + map_margin)
	            .attr("height", map_height + map_margin)
	            .append('g')
	            .attr('class', 'map');
	       
	        var projection = d3.geo.mercator()
								   .scale(map_scale)
								   .translate([map_width/2, map_height/1.8]);
	        
	        var path = d3.geo.path().projection(projection);
	
	        var map = svg.selectAll('path')
						 .data(geo_data.features)
						 .enter()
						 .append('path')
						 .attr('d', path)
						 .style('fill', '#f7fbff')	 
						 .style('stroke', 'black')
						 .style('stroke-width', 0.5)
                         .append('svg:title')
                         .text(function(d) {
						        return d.properties.name
					         })
					     .append('svg:legend');
				         
				d3.csv("avg_scores_by_country_complete3.csv", pick_color)	
		}
		
	function pick_color(data) {
		var svg = d3.select("#map_div")
		data.map(function (d) {
				d.math = +d.math;
				d.reading = +d.reading;
				d.science = +d.science;
		})
		
		if (subject == "math") {
			var colors = ["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"];
		}
		if (subject == "reading") {
			var colors = ["#edf8e9","#bae4b3","#74c476","#31a354","#006d2c"];
		}
		if (subject == "science") {
			var colors = ["#feedde","#fdbe85","#fd8d3c","#e6550d","#a63603"]
		}
			
					
		var score_extent = d3.extent(data, function(d) {
				return d[subject];
			});
			
		var score_scale = d3.scale.quantile()
						   .domain(score_extent)
						   .range(colors);

		
		// create object that pairs countries with correct color		
		var color_assignments = {};
		var l = data.length;
		for (var i = 0; i < l; i++) {
			color_assignments[data[i].country] = score_scale(data[i][subject]);
		}
		
		function update_color(d) {
			if (d.properties.name in color_assignments) {
				return color_assignments[d.properties.name]
			} else {
				return 'white'
			}
		}
		
		// create object that pairs countries with math scores
		var scores = {};
		for (var i = 0; i < l; i++) {
			scores[data[i].country] = data[i][subject].toFixed(0);
		}
		
		function update_score(d) {
			if (d.properties.name in color_assignments) {
				return [d.properties.name,
				scores[d.properties.name]];
			} else {
				return [d.properties.name, "no data available"];
			}
		}
		
		// click code
		function on_click(d) {
			country = d.properties.name;
			//d3.csv('quintiles.csv', add_scatter);
		}

		// update colors, hover-text					
		svg.selectAll('path')
		   .style('fill', update_color)
		   .on('click', on_click)
		   
		
		svg.selectAll('title')
		   .text(update_score)
		
		// draw legend
		var min_score = score_extent[0].toFixed(0)
		var max_score = score_extent[1].toFixed(0)
		color_scale = {}
		for (var i = min_score; i < max_score; i++) {
			color_scale[i] = score_scale(i)
			if (color_scale[i-1] == color_scale[i]) {
				delete color_scale[i-1];
			}
		}
								
	}
	
	function add_scatter(data) {
		"use strict"
		data.map(function (d) {
							d.prob = +d.prob;
							d.escs = +d.escs;
							d.math = +d.math;
							d.reading = +d.reading;
							d.science = +d.science;
				});

		var scatter = d3.select("body")
					.append("svg")
					.attr("width", width + margin)
					.attr("height", height + margin)
					.append('g')
					.attr('class', 'chart');
					
		d3.select('svg')
		  .selectAll('circle')
		  .data(data.filter(function(d) { return d.country == country }))
		  .enter()
		  .append('circle') 
		  
			
		  // append svg to page corresponding to the d3 x-axis
		  d3.select("svg")
			.append('g')
			.attr('class', 'x axis')
			.attr('transform', "translate(0," + height + ")")
			.call(escs_axis);
		  
		  // append svg to page corresponding to the d3 y-axis	
		  d3.select("svg")
			.append('g')
			.attr('class', 'y axis')
			.attr('transform', "translate(" + 2.2*width/3 + ",0)")
			.call(score_axis);
			
		  d3.selectAll('circle')
              .attr('cx', function(d) {
                  return x_scale(d['escs']);
              })
              .attr('cy', function(d) {
                  return y_scale(d[subject]);
              })
              .attr('r', radius)
              .attr('fill', 'blue');
			
	}
	
	/*
    // global variables
	var margin = 75,
	    width = 1500 - margin,
	    height = 730 - margin;
	var radius = 5
	
	// horizontal axis
	var x_extent = [-2.75, 3.69];
	var x_scale = d3.scale.linear()
		.range([2.2*width/3, width])
		.domain(x_extent);
	var escs_axis = d3.svg.axis()
		.scale(x_scale);
	  
	// vertical axis
	var y_extent = [312, 672];
	var y_scale = d3.scale.linear()
		.range([height, height/2])
		.domain(y_extent);
	var score_axis = d3.svg.axis()
		.scale(y_scale)
		.orient("left");
	*/
    		
	function redraw(c) {
		subject = c;
		d3.csv("avg_scores_by_country_complete3.csv", pick_color)
	}
	
	subject = "math"
	d3.json("world_countries.json", draw);


    </script>
    
</body>
</html>
